name: Test documentation

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/test-docs.yml
      - altdoc/mkdocs.yml
      - man/**
  pull_request:
    branches:
      - main
    paths:
      - .github/workflows/test-docs.yml
      - altdoc/mkdocs.yml
      - man/**
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test-docs:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check missing man pages in mkdocs.yml
        run: |
          YAML_FILE="altdoc/mkdocs.yml"
          FILE_LIST=(man/*.Rd)

          # Track missing files
          missing=0

          for file in "${FILE_LIST[@]}"; do
              base=$(basename "$file" .Rd)
              expected_name="$base.md"

              if ! grep -q "$expected_name" "$YAML_FILE"; then
                  echo "Missing in mkdocs.yml: $expected_name"
                  missing=1
              fi
          done

          if [ "$missing" -ne 0 ]; then
              echo "One or more man pages are not referenced in mkdocs.yml."
              exit 1
          fi

      - name: Check pages in mkdocs.yml that don't exist in "man" folder
        run: |
          YAML_FILE="altdoc/mkdocs.yml"
          MAN_DIR="man"
          missing=0

          # Extract all paths in mkdocs.yml that start with "man/" and end with ".md"
          grep -oP 'man/\S+?\.md' "$YAML_FILE" | while read -r md_path; do
              # Convert .md path to .Rd path
              rd_file="${md_path%.md}.Rd"

              # Check if the corresponding .Rd file exists
              if [ ! -f "$rd_file" ]; then
                  echo "Exists in mkdocs.yml but not in 'man': $rd_file"
                  missing=1
              fi
          done

          # Exit with error if any files are missing
          if [ "$missing" -ne 0 ]; then
              echo "One or more man pages are referenced in mkdocs.yml but don't exist in 'man'."
              exit 1
          fi
